# 展望未来，HTTP/3

- [HTTP/1的诞生与缺陷](#HTTP/1的诞生与缺陷)
- [HTTP2的诞生与缺陷](#HTTP2的诞生与缺陷)
- [HTTP/3的诞生](#HTTP/3的诞生)

## HTTP/1的诞生与缺陷

### 1、HTTP/1的诞生

​	HTTP 协议为 Web 的发展提供了驱动力，它始于 1991 年的 HTTP/0.9，在 1999 年演变为 HTTP/1.1，并由 IETF（互联网工程任务组）负责进行标准化 。HTTP/1.1自发布以来，我们已经使用HTTP/1.x 相当长一段时间了，但是随着近十年互联网的爆炸式发展，从当初网页内容以文本为主,到现在以富媒体（如图片、声音、视频）为主,而且对页面内容实时性高要求的应用越来越多(比如聊天、视频直播),于是当时协议规定的某些特性，已经无法满足现代网络的需求了。 

### 2、HTTP/1的缺陷
- 1.高延迟--带来页面加载速度的降低
- 2.无状态特性--带来的巨大HTTP头部
- 3.明文传输--带来的不安全性

## HTTP/2的诞生与缺陷

### 1、SPDY协议

- 描述

  2009年谷歌公开了自行研发的 SPDY（读作“speedy”） 协议，该协议是基于[TCP](https://baike.baidu.com/item/TCP/33012)的会话层协议，用以最小化网络延迟，提升网络速度，优化用户的网络使用体验。SPDY并不是一种用于替代HTTP的协议，而是对[HTTP](https://baike.baidu.com/item/HTTP)协议的增强。新协议的功能包括数据流的多路复用、请求优先级以及HTTP报头压缩

- 特点

  1.复用连接，可在一个TCP连接上传送多个资源。应对了[TCP慢启动](http://zhidao.baidu.com/link?url=k7QG6emE7GI5jOV1gE9Y3reWMyPz9yXuXBLkwJ8KtgZ--RzqBBFaADhfPlZkUgcg0GYB8zTdpN3eN5rTz_yUV_)的特性。

  2.请求分优先级，重要的资源优先传送。

  3.HTTP头部数据也被压缩，省流量。

SPDY的实践证明了这些优化的效果，也最终带来HTTP/2的诞生。

### 2、HTTP/2的诞生
​	2015年，HTTP/2 发布。HTTP/2是现行HTTP协议（HTTP/1.x）的替代，但它不是重写，HTTP方法/状态码/语义都与HTTP/1.x一样。**HTTP/2基于SPDY，专注于性能，最大的一个目标是在用户和网站间只用一个连接（connection）**。  HTTP/2率先引入了**HTTP“流”**的概念：这是一种抽象概念，允许 HTTP 实现将不同的 HTTP 交换并发地复用到同一 TCP 连接上， 使浏览器更高效地复用 TCP 连接。 

![](./img/http2.webp)

### 3、HTTP/2的缺陷

​	虽然 HTTP/2 解决了很多之前旧版本的问题，但是它还是存在一个巨大的问题，**主要是底层支撑的 TCP 协议造成的**。HTTP/2的缺点主要有以下几点 

- TCP 以及 TCP+TLS建立连接的延时 

  HTTP/2都是使用TCP协议来传输的，而如果使用HTTPS的话，还需要使用TLS协议进行安全传输，而使用TLS也需要一个握手过程，**这样就需要有两个握手延迟过程**： 

   ①在建立TCP连接的时候，需要和服务器进行三次握手来确认连接成功，也就是说需要在消耗完1.5个RTT(**Round Trip Time**)之后才能进行数据传输。 

   ②进行TLS连接，TLS有两个版本——TLS1.2和TLS1.3，每个版本建立连接所花的时间不同，大致是需要1~2个RTT。 

   总之，在传输数据之前，我们需要花掉 3～4 个 RTT。

- TCP的队头阻塞并没有彻底解决 

  在HTTP/2中，多个请求是跑在一个TCP管道中的。但当出现了丢包时，HTTP/2 的表现反倒不如 HTTP/1 了。因为TCP为了保证可靠传输，有个特别的**“丢包重传”**机制，丢失的包必须要等待重新传输确认，HTTP/2出现丢包时，整个 TCP 都要开始等待重传，那么就会阻塞该TCP连接中的所有请求（如下图）。而对于 HTTP/1.1 来说，可以开启多个 TCP 连接，出现这种情况反到只会影响其中一个连接，剩余的 TCP 连接还可以正常传输数据。 

![](./img/SPDY.gif)

## HTTP/3的诞生

### 1、简介

​	Google 在推 **SPDY** 的时候就已经意识到了这些问题，于是就另起炉灶搞了一个基于 **UDP协议** 的 **QUIC协议** (**Quick UDP Internet Connection**)，让HTTP跑在 **QUIC** 上而不是 **TCP** 上。而这个 **HTTP over QUIC** 就是HTTP协议的下一个大版本，HTTP/3。它在HTTP/2的基础上又实现了质的飞跃，真正“完美”地解决了`队头阻塞`问题。

![](./img/http3.jpeg)

### 2、UDP协议

 - 概述

   ​	**UDP**是**User Datagram Protocol**的简称，是[TCP／IP](HTTPs://wiki.mbalib.com/wiki/TCP／IP)体系结构中一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。UDP协议是IP协议与上层协议的接口，用端口号分别为运行在同一设备上的多个应用程序提供服务。它定义在IETFRFC768中。 

 - 特点

   1. UDP是一个[无连接协议](HTTPs://baike.baidu.com/item/无连接协议)，即发送数据之前不需要建立连接(发送数据结束时也没有连接可释放)，减少了开销和发送数据之前的时延

   2. UDP 使用`尽最大努力交付`，即不保证可靠交付，主机不需要维持复杂的连接状态表

   3. UDP是`面向报文`的。发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付给IP层。既不拆分，也不合并，`而是保留这些报文的边界`。

      ![](./img/udp.jpg)

   4. UDP`没有拥塞控制`，网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的

   5. UDP 支持一对一、一对多、多对一和多对多的交互通信 

   6. UDP 的`首部开销小`，只有8个字节，比 TCP 的20个字节的首部要短 

- 存在问题
  1. UDP协议并不提供数据传送的保证机制。如果在从发送方到接收方的传递过程中出现数`据包的丢失`，协议本身并不能做出任何检测或提示。因此，通常人们把UDP协议称为不可靠的[传输协议](HTTPs://baike.baidu.com/item/传输协议)。
  2. UDP 在传输数据前不建立连接，不对数据报进行检查与修改，无须等待对方的应答，所以会出现`分组丢失、重复、乱序`，应用程序需要负责传输可靠性方面的所有工作。
  3.  某些实时应用需要使用没有拥塞控制的 UDP，但很多的源主机同时都向网络发送高速率的实时视频流时，网络就有可能发生拥塞，导致大家都无法正常接收。

### 3、QUIC协议

​	上面我们提到QUIC基于UDP，而UDP是“无连接”的，根本就不需要“握手”和“挥手”，所以就比TCP来得快。此外QUIC也实现了可靠传输，保证数据一定能够抵达目的地。它还引入了类似HTTP/2的“流”和“多路复用”，单个“流"是有序的，可能会因为丢包而阻塞，但其他“流”不会受到影响。具体来说QUIC协议有以下特点

- 实现了类似TCP的流量控制、传输可靠性的功能

  虽然UDP不提供可靠性的传输，但QUIC在UDP的基础之上增加了一层来保证数据可靠性传输。它提供了数据包重传、拥塞控制以及其他一些TCP中存在的特性。

- 实现了快速握手功能 

  由于QUIC是基于UDP的，所以QUIC可以实现使用0-RTT或者1-RTT来建立连接，这意味着QUIC可以用最快的速度来发送和接收数据，这样可以大大提升首次打开页面的速度。**0RTT 建连可以说是 QUIC 相比 HTTP2 最大的性能优势**。

- 集成了TLS加密功能 

  目前QUIC使用的是TLS1.3，相较于早期版本TLS1.3有更多的优点，其中最重要的一点是减少了握手所花费的RTT个数 。

- 多路复用，彻底解决TCP中队头阻塞的问题

  和TCP不同，QUIC实现了在同一物理连接上可以有多个独立的逻辑数据流（如下图）。实现了数据流的单独传输，就解决了TCP中队头阻塞的问题

![](./img/QUIC.png)

## 使用HTTP/3

### 使用谷歌 Chrome 作为 HTTP/3 客户端

​	为了使用 Chrome 浏览器通过 HTTP/3 连接到你的网站，你首先需要下载并安装 [最新的 Canary 版本](https://www.google.com/chrome/canary/) 。然后使用 –enable-quic 和 –quic-version=h3-23 命令行参数启动 Chrome Canary。

Windows 系统使用命令行参数启动 Chrome Canary：

- 选择“快捷方式”标签，在快捷方式上右键，选择属性
- 在 “目标” 一行的末尾，添加上启动参数
- 最终效果应该像这样： ……\chrome.exe -enable-quic -quic-version=h3-23

​	使用必需的参数启动 Chrome 后，你只需在地址栏中输入你的域，然后查看它是否已通过 HTTP/3 加载（你可以使用 Chrome 开发人员工具中的“Network”选项卡来检查所使用的协议版本）。请注意，由于浏览器和服务器之间协商 HTTP/3 的方式，HTTP/3 可能不会用于到域的前几个连接，因此你应该尝试重新加载几次页面。

​	如果这看起来太复杂了，但也请放心，因为随着时间的流逝，Chrome 对 HTTP/3 的支持将变得更加稳定，启用 HTTP/3 将会变得更加容易。

​	下图是通过 HTTP/3 浏览 [此博客](https://blog.cloudflare.com/) 时，开发人员工具中的“Network”选项卡显示的内容：

![](./img/http3.png)

​	注意，由于 Chrome 对 HTTP/3 支持的实验性质，该协议在开发人员工具中实际上被标识为“ http2+quic/99”，但请不要误解，它就是 HTTP/3。

## 总结

- HTTP/1.1有两个主要的缺点：安全不足和性能不高 。
- HTTP/2完全兼容HTTP/1，是“更安全的HTTP、更快的HTTPS"，头部压缩、多路复用等技术可以充分利用带宽，降低延迟，从而大幅度提高上网体验；
- QUIC 协议，是 HTTP/3 中的底层支撑协议，该协议基于 UDP，又取了 TCP 中的精华，实现了即快又可靠的协议。 

## 参考资料

- [HTTP/3的过去、现在和未来](https://www.infoq.cn/article/x80uOvcRyxVYw3KVusUm)
- [解读HTTP/2与HTTP/3的新特性](https://mp.weixin.qq.com/s/n8HBG9LuzQjOT__M4pxKwA)
- [百度百科UDP协议](https://baike.baidu.com/item/UDP/571511?fr=aladdin)
- [UDP协议-看这篇就够了](https://segmentfault.com/a/1190000018902719)

